<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">

    <title>Building Games with Akka FSM</title>

    <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon; charset=binary">

    <meta name="description" content="Building Games with Akka FSM">
    <meta name="author" content="Josep Prat">

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/beige.css" id="theme">
    <link rel="stylesheet" href="css/gd.css"/>

    <!-- Code syntax highlighting -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- Printing and PDF exports -->
    <script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
		
		
    <script>
  	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  	ga('create', 'UA-68268154-1', 'auto');
  	ga('send', 'pageview');

     </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
</head>

<body>

<div id="gdSlides" class="reveal">
    <div class="badge"></div>

    <!-- Any section element inside of this container is displayed as a slide -->
    <div class="slides">

        <section>
            <div class="logo"></div>
            <h1 >Building Games with Akka FSM</h1>
            <footer>
                <p class="author">
                    <small>GOTO nights| 2015/10/07 | Josep Prat | GameDuell GmbH | <a href="http://twitter.com/jlprat">@jlprat</a></small>
                </p>
            </footer>
        </section>
        <section>
            <section>
                <h1>Why Games?</h1>
            </section>
            <section>
                <blockquote>"We've been playing games since humanity had civilization - there is something primal about our desire and our ability to play games"<br>Jane McGonigal</blockquote>
            </section>
            <section id="motto" data-background="images/GD_motto.png" data-background-size="contain" data-transition="linear" data-background-transition="slide">
                <h1>GameDuell</h1>
                <h3>Bringing people together to have good times with games - Wherever, whenever!</h3><br><br><br>
            </section>
            <section>
                <h2>Some Facts</h2>
                <ul>
                    <li>Founded in Berlin back in 2003</li>
                    <li>Over 220 Employees</li>
                    <li>More than 70 Games</li>
                    <li>Over 125 Million Players</li>
                    <li>Tech Talks with World Experts</li>
                </ul>
            </section>
        </section>
        <section>
            <h1>What to expect</h1>
            <ul>
                <li>Converting Games to State Machines</li>
                <li>What is Akka</li>
                <li>Writing FSM with Akka</li>
            </ul>
        </section>
        <section>
            <section>
                <h1>Games</h1>
                <h3 class="fragment">but... what type of games?</h3>
            </section>
            <section>
                <h2>Single Player</h2>
                <img src="images/space_invaders.jpg" alt="http://best-games.fr/wp-content/thumbs/space_invaders1_1343057412.jpg"/>
            </section>
            <section>
                <h2>Multiplayer</h2>
                <img src="images/bel.png"/>
            </section>
            <section>
                <h2>Challenges for Multiplayer Games</h2>
                <ul>
                    <li>Synchronization</li>
                    <li>Data Integrity</li>
                    <li>Resilient</li>
                    <li>Responsive</li>
                </ul>
            </section>
            <section>
                <h2>A game is just a FSM behind the scenes</h2>
                <img src="images/simpleStateMachine.svg" alt="Finite-State Machine Sample" class="no-border"/>
            </section>
            <section>
                <h1>Not this!!!</h1>
                <img class="half" src="images/fsm_monster.png" alt="http://img07.deviantart.net/1381/i/2008/268/9/e/the_flying_spaghetti_monster_by_kaddywhak.png"/>
            </section>
            <section>
                <h2>Finite-State Machine</h2>
                <blockquote>
                    <p>
                        Is a mathematical model of computation used to design both computer programs and sequential logic circuits. It is conceived as an abstract machine that can be in one of a finite number of states.
                    </p>
                    Wikipedia
                </blockquote>
            </section>
            <section>
                <h2>How it works</h2>
                <ul>
                    <li>The machine is in only one state at a time</li>
                    <li>It can change from one state to another when initiated by a triggering event or condition</li>
                    <li>It is defined by both a list of its states and the triggering condition for each transition</li>
                    <li>It can have a set of entry and exit actions</li>
                </ul>
            </section>
            <section>
                <h2>Translating Games into FSM</h2>
                <h3 class="fragment">Let's pick a Game</h2>
            </section>
            <section>
                <h2>Battleship</h2>
                <img src="images/battleshipGame.png" alt="Battleship board game"/>
            </section>
            <section>
                <h2>Rules</h2>
                <ul>
                    <li>Every player places their ships in a 10x10 board</li>
                    <li class="fragment">Each ship occupies a number of consecutive squares on the grid, vertically or horizontally</li>
                    <li class="fragment">Each type of ship occupies a determined number of squares</li>
                    <li class="fragment">Each player selects a position to shoot in turns</li>
                    <li class="fragment">Opponent must reveal if a ship was hit or not</li>
                    <li class="fragment">When all squares occupied by a ship are hit, the ship is sunk</li>
                    <li class="fragment">When a player sinks all opponent's ships, the game is over</li>
                </ul>
            </section>
            <section>
                <h2>Building the Finite-State Machine</h2>
                <!-- TODO place ships one by one -->
                <img src="images/battleship.svg" alt="Battleship game FSM" class="no-border"/>
            </section>
            <section>
                <h2>Let's Add Timers</h2>
                <!-- TODO update this after the previous is done -->
                <img src="images/battleship_timers.svg" alt="Battleship game FSM with timers" class="no-border"/>
            </section>
        </section>
        <section>
            <section>
                <h1>What is Akka?</h1>
            </section>
            <section>
                <h2>Akka...</h2>
                <ul>
                    <li>Is an Open-source toolkit and runtime</li>
                    <li>Aims to simplify concurrent and distributed applications</li>
                    <li>Supports multiple programming models</li>
                    <li>Emphasizes the Actor Model, deeply inspired by Erlang's Actor Model</li>
                    <li>Has both Java and Scala APIs</li>
                </ul>
            </section>
            <section>
                <h2>Actors in General</h2>
                <p>Actors are lightweight programmable queues of immutable messages which are processed asynchronously and in a non-concurrent fashion. They can communicate with other actors via immutable messages.</p>
                <p class="fragment">Also known as:<br/><code>Any => Unit</code></p>
            </section>
            <section>
                <h2>Some Benefits of Using Actors</h2>
                <ul>
                    <li>No need for Locking</li>
                    <li>Message Driven</li>
                    <li>Scalability</li>
                    <li>Better analogies with human behavior</li>
                </ul>
            </section>
            <section>
                <h2>Akka FSM</h2>
                <p>A subtype of Actors that model a Finite-State Machine. It's described as a set of relations of:<br/><code>State(S) x Event(E) -> Actions(A), State(S')</code></p>
            </section>
            <section>
                <h1 class="blink">Warning!!</h1>
                <h1 class="blink">Scala Code Ahead!!</h1>
            </section>
            <section>
                <h2>A simple Example (I)</h2>
                <pre><code>sealed trait Message
case object Ping extends Message
case object Pong extends Message

sealed trait State
case object WaitingPing extends State
case object WaitingPong extends State

case class Data(times: Int)
                </code></pre>
            </section>
            <section>
                <h2>A simple Example (and II)</h2>
                <pre><code>class PingPongFSM extends Actor with FSM[State, Data] {

  startWith(WaitingPing, stateData = new Data(0))

  when(WaitingPing) {
    case Event(Ping, data:Data) =>
      println(s"Received Ping, transition ${data.times}")
      goto(WaitingPong) using new Data(data.times + 1)
  }

  when(WaitingPong) {
    case Event(Pong, data:Data) =>
      println(s"Received Pong, transition ${data.times}")
      goto(WaitingPing) using new Data(data.times + 1)
  }
  initialize()
}</code></pre>
            </section>
            <section>
                <h2>Running It</h2>
                <pre><code>val pingPongFSM = system.actorOf(Props[PingPongFSM], "PingPongFSM")
pingPongFSM ! Ping
pingPongFSM ! Ping
pingPongFSM ! Pong
pingPongFSM ! Ping

>Received Ping, transition 0
>[WARN] ... unhandled event Ping in state WaitingPong
>Received Pong, transition 1
>Received Ping, transition 2</code></pre>
            </section>
        </section>
        <section>
            <section>
                <h1>Games to Akka FSM</h1>
            </section>
            <section>
                <h2>Remember the Battleship Game?</h2>
                <img src="images/battleship.svg" alt="Battleship game FSM" class="no-border"/>
            </section>
            <section>
                <h2>Let's create the State Objects</h2>
                <pre><code>sealed trait BattleshipState
case object WaitingForPlayers extends BattleshipState
case object PlacingShips extends BattleshipState
case object WaitingForNextPlayer extends BattleshipState
case object CheckingShot extends BattleshipState
case object HitShip extends BattleshipState
case object EndGame extends BattleshipState</code></pre>
            </section>
            <section>
                <h2>Now the Messages Sent</h2>
                <pre><code>sealed trait BattleshipMessages
case class PlaceShip(playerId: Int, id: Short, coord: Coord, size: Short, vertical: Boolean) extends BattleshipMessages
case object ShipsPlaced
case object NextPlayer
case class PlaceShot(playerId: Int, coord: Coord) extends BattleshipMessages
case object Miss extends BattleshipMessages
case object Hit extends BattleshipMessages
case object ShipsAlive extends BattleshipMessages
case object AllShipsSunk extends BattleshipMessages</code></pre>
            </section>
            <section>
                <h2>What do we need as a State Data?</h2>
                <ul>
                    <li class="fragment">Both Grids</li>
                    <li class="fragment">Who is in turn</li>
                    <li class="fragment">Ships to Place</li>
                    <li class="fragment">Shot to Check</li>
                </ul>
            </section>
            <section>
                <h2>Let's focus on the first state</h2>
                <img src="images/battleship.svg" alt="Battleship game FSM" class="no-border"/>
            </section>
            <section>
                <h2>Let's focus on the first State</h2>
                <pre><code>class BattleShipActor extends ActorLogging
   with FSM[BattleshipState, BattleshipData] {
 ...
 when(WaitingForPlayers) {
  case Event(PlaceShip(playerId, shipId, coord, size, vertical), data)=>
  goto(PlacingShips) using
    data.placeShip(playerId, shipId, coord, size, vertical)
 }
}</code></pre>
                <h3 class="fragment">Easy, huh?</h3>
            </section>
            <section>
                <h2>Let's focus on the second state</h2>
                <img src="images/battleship.svg" alt="Battleship game FSM" class="no-border"/>
            </section>
            <section>
                <h2>Let's focus on the second state</h2>
                <pre><code>when(PlacingShips) {
 case Event(PlaceShip(playerId, shipId, coord, size, vertical), data)=>
   stay using data.placeShip(playerId, shipId, coord, size, vertical)
 case Event(ShipsPlaced, data) =>
   goto(WaitingForNextPlayer)
}</code></pre>
                <h3>Who sends this Ships Placed message?</h3>
            </section>
            <section>
                <h2>We must define our Entry Actions!</h2>
                <pre><code>onTransition {
 case _ -> PlacingShips =>
   if (nextStateData.shipsToPlace.forall(_.isEmpty)) self ! ShipsPlaced</code></pre>
            </section>
            <section>
                <h2>However, This won't work</h2>
                <p><code>onTransition</code> only works when there is a transition of a state. Not when staying</p>
            </section>
            <section>
                <h2>State Machine Revisited!</h2>
                <img src="images/battleship_revisited.svg" alt="Battleship game FSM" class="no-border"/>
            </section>
            <section>
                <h2>Let's check the code again</h2>
                <pre><code>when(PlacingShips) {
 case Event(PlacedShip, _) =>
  goto(CheckingPlacedShips)
}

when(CheckingPlacedShips) {
 case Event(PlaceShip(playerId, shipId, coord, size, vertical), data)=>
  goto(PlacingShips) using data.placeShip(playerId, shipId, coord, size, vertical)
 case Event(ShipsPlaced, _) =>
  goto(WaitingForNextPlayer)
}</code></pre>
            </section>
            <section>
                <h2>And the Transition Handlers</h2>
                <pre><code>case _ -> PlacingShips => self ! PlacedShip
case _ -> CheckingPlacedShips =>
 if (nextStateData.shipsToPlace.forall(_.isEmpty)) self ! ShipsPlaced</code></pre>
            </section>
            <section>
                <h2>Let's tackle the remaining states</h2>
                <img src="images/battleship_revisited.svg" alt="Battleship game FSM" class="no-border"/>
            </section>
            <section>
                <h2>Let's tackle the remaining states</h2>
                <pre><code>when(WaitingForNextPlayer) {
 case Event(NextPlayer, data) =>
  stay using data.copy(currentPlayer = data.opponent)
 case Event(PlaceShot(playerId, x, y), data) =>
  goto(CheckingShot) using data.copy(pendingShot = Some(x, y))
}
when(CheckingShot) {
 case Event(Miss, data) =>
  goto(WaitingForNextPlayer) using data.copy(pendingShot = None)
 case Event(Hit, data) =>
  goto(HitShip) using data.shoot.copy(pendingShot = None)
}
when(HitShip) {
 case Event(ShipsAlive, data) =>
  goto(WaitingForNextPlayer) using data
 case Event(AllShipsSunk, _) =>  goto(EndGame)
}</code></pre>
            </section>
            <section>
                <h2>With their Entry Actions</h2>
                <pre><code>case _ -> WaitingForNextPlayer =>
  log.info(s"End of ${nextStateData.currentPlayer} turn")
  self ! NextPlayer
case _ -> CheckingShot =>
  if (nextStateData.wouldBeAShot) {
    log.info("Ship Hit at ${nextStateData.pendingShot}!")
    self ! Hit
  }
  else {
    log.info(s"Missed at ${nextStateData.pendingShot}!")
    self ! Miss
  }
case _ -> HitShip =>
  if (nextStateData.areShipsAlive(nextStateData.opponent))
    self ! ShipsAlive
  else self ! AllShipsSunk
case _ -> EndGame => log.info("Game is Over")</code></pre>
            </section>
            <section>
                <h2>What Happens with Timers?</h2>
                <img src="images/battleship_timers_revisited.svg" alt="Battleship game FSM" class="no-border"/>
            </section>
            <section>
                <h2>We can add State Timeouts</h2>
                <pre><code>when(WaitingForNextPlayer, stateTimeout = 30 seconds) {
 case Event(NextPlayer, data) =>
  stay using data.copy(currentPlayer = data.opponent)
 case Event(PlaceShot(playerId, x, y), data) =>
  goto(CheckingShot) using data.copy(pendingShot = Some(x, y))
 case Event(StateTimeout, data) =>
  stay using data.copy(currentPlayer = data.opponent)
}</code></pre>
            </section>
        </section>
        <section>
            <section>
                <h1>Wrap Up</h1>
                <ul>
                    <li>Nice DSL for building FSM</li>
                    <li>Forget locks!</li>
                    <li>Focused on state-centric FSM</li>
                    <li>You might need to adapt your FSM to Akka</li>
                    <li>Extensive use of Mocks for testing</li>
                </ul>
            </section>
            <section>
                <h2>For the next game you build...</h2>
                <h1 class="fragment">...give Akka a try</h1>
            </section>
        </section>
        <section>
            <h1>Q & A</h1>
        </section>
        <section>
            <h1>Further Information</h1>
            <div><a href="http://inside.gameduell.com/">inside.gameduell.com</a></div>
            <div><a href="http://www.techtalk-berlin.de/">www.techtalk-berlin.de</a></div>
        </section>
    </div>

</div>

<script src="lib/js/head.min.js"></script>
<script src="js/reveal.js"></script>

<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});

		</script>

</body>
</html>
